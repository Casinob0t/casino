<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crash</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .card { padding: 14px; border: 1px solid #ddd; border-radius: 12px; }
    button { width: 100%; padding: 12px; border-radius: 12px; border: 0; font-size: 16px; }
    input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; }
    .row { margin-top: 10px; }
    .big { font-size: 28px; font-weight: 700; }
  </style>
</head>
<body>
  <div class="card">
    <div class="big" id="mult">1.00×</div>
    <div id="status">Ready</div>

    <div class="row">
      <label>Bet</label>
      <input id="bet" type="number" min="1" step="1" value="10" />
    </div>

    <div class="row">
      <label>Auto cashout (optional)</label>
      <input id="auto" type="number" min="1.01" step="0.01" placeholder="e.g. 2.00" />
    </div>

    <div class="row">
      <button id="start">Start Round</button>
    </div>

    <div class="row">
      <button id="cashout" disabled>Cash Out</button>
    </div>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  const multEl = document.getElementById("mult");
  const statusEl = document.getElementById("status");
  const betEl = document.getElementById("bet");
  const autoEl = document.getElementById("auto");
  const startBtn = document.getElementById("start");
  const cashBtn = document.getElementById("cashout");

  let running = false;
  let t0 = 0;
  let raf = null;

  function setStatus(s){ statusEl.textContent = s; }

  // purely visual multiplier curve (server decides outcome)
  function visualMult(ms) {
    // smooth-ish curve: starts slow, ramps
    const t = ms / 1000;
    return 1 + (t * 0.35) + (t*t * 0.03);
  }

  function tick(){
    const ms = performance.now() - t0;
    const m = visualMult(ms);
    multEl.textContent = m.toFixed(2) + "×";

    const auto = parseFloat(autoEl.value);
    if (running && !Number.isNaN(auto) && m >= auto) {
      doCashout(m);
      return;
    }

    raf = requestAnimationFrame(tick);
  }

  function doStart(){
    if (running) return;
    const bet = parseInt(betEl.value || "0", 10);
    if (!bet || bet < 1) { setStatus("Enter a valid bet"); return; }

    running = true;
    cashBtn.disabled = false;
    startBtn.disabled = true;
    setStatus("Running...");
    multEl.textContent = "1.00×";
    t0 = performance.now();
    raf = requestAnimationFrame(tick);

    // Tell bot: start crash round with bet (bot will create the real round)
    tg.sendData(JSON.stringify({ action: "crash_start", bet }));
  }

  function doCashout(visualM){
    if (!running) return;
    running = false;
    cashBtn.disabled = true;
    startBtn.disabled = false;
    setStatus("Cashout sent...");

    if (raf) cancelAnimationFrame(raf);

    tg.sendData(JSON.stringify({ action: "crash_cashout", visual_mult: Number(visualM.toFixed(2)) }));
  }

  startBtn.addEventListener("click", doStart);
  cashBtn.addEventListener("click", () => doCashout(parseFloat(multEl.textContent)));

</script>
</body>
</html>
